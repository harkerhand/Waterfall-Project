# **用户数据存储与处理后端设计文档**

## **存储方式**
- 使用 **CSV 文件** 存储用户账号和密码数据，文件路径为 `assets/users.csv`
- **新增用户数据** 会通过文件追加的方式写入。
- **用户数据结构**：
  ```plaintext
  username,password
  ```
  - `username`：用户账号，唯一标识。
  - `password`：用户密码，存储为加密后的字符串（采用 `bcrypt` 加密算法）。

---

## **API 设计**

### **1. 登录接口 (`/login`)**
**功能**  
- 校验用户输入的用户名和密码是否正确。

**接口定义**  
- **URL**：`/login`  
- **请求方式**：`POST`  
- **请求参数**（JSON 格式）：  
  ```json
  {
      "username": "string",
      "password": "string"
  }
  ```
  
**逻辑说明**  
1. 从请求体中提取 `username` 和 `password` 参数。  
2. 读取 `users.csv` 文件中的用户数据，并查找匹配的用户名记录：  
   - 如果找不到用户，返回错误响应：`用户名或密码错误`。  
3. 如果找到用户：  
   - 验证输入的密码与存储的加密密码是否匹配。  
   - 如果匹配，返回成功响应：`登录成功`。  
   - 如果不匹配，返回错误响应：`用户名或密码错误`。

**响应示例**  
- 成功：
  ```json
  {
      "message": "登录成功"
  }
  ```
- 失败：
  - 用户名不存在或密码错误：
    ```json
    {
        "message": "用户名或密码错误"
    }
    ```
  - 服务端错误：
    ```json
    {
        "message": "登录失败，请稍后再试"
    }
    ```

---

### **2. 注册接口 (`/register`)**
**功能**  
- 注册新用户，添加到 `users.csv` 文件中。

**接口定义**  
- **URL**：`/register`  
- **请求方式**：`POST`  
- **请求参数**（JSON 格式）：  
  ```json
  {
      "username": "string",
      "password": "string"
  }
  ```

**逻辑说明**  
1. 从请求体中提取 `username` 和 `password` 参数。  
2. 读取 `users.csv` 文件中的用户数据，检查是否存在相同的用户名：  
   - 如果用户名已存在，返回错误响应：`用户名已存在`。  
3. 如果用户名不存在：  
   - 对密码进行加密（使用 `bcrypt.hash`）。  
   - 将新用户追加到 `users.csv` 文件。  
4. 返回成功响应：`注册成功`。

**响应示例**  
- 成功：
  ```json
  {
      "message": "注册成功"
  }
  ```
- 失败：
  - 用户名已存在：
    ```json
    {
        "message": "用户名已存在"
    }
    ```
  - 服务端错误：
    ```json
    {
        "message": "注册失败，请稍后再试"
    }
    ```

---

## **存储处理逻辑**

### **从 CSV 文件读取用户数据**  
- 函数：`readUsersFromCsv`  
- **实现**：
  - 通过 `fs.createReadStream` 读取文件，结合 `csv-parser` 模块解析数据为 JSON 对象数组。
  - 返回所有用户信息，供后续操作使用。

### **将新用户写入 CSV 文件**  
- 函数：`appendUserToCsv`  
- **实现**：
  - 使用 `fs.appendFile` 将用户信息以逗号分隔的形式追加到 CSV 文件。
  - 确保写入操作是异步完成的。

---

## **安全性说明**
1. **密码加密**：  
   - 使用 `bcrypt` 模块对密码进行加密，存储加密后的哈希值，确保用户数据的安全性。
2. **错误提示**：  
   - 避免详细说明验证失败的原因，统一提示 `用户名或密码错误`，防止信息泄露。
3. **CORS 支持**：  
   - 使用 `cors` 中间件，允许跨域请求，便于前端与后端联调。
